# LibRandomPool (randp)

LibRandomPool (also known as <q>randp</q>) is a library, designed for modern Linux systems, with functions that give pseudorandom numbers.  It was inspired by [arc4random](https://en.wikipedia.org/wiki/RC4#RC4-based_random_number_generators), and it mimics its functionality.

## API

The API is designed to be compatible with the arc4random family of functions.

| Description | arc4random family | randp family |
|---|---|---|
| Fill a buffer with _n_ random bytes | `void arc4random_buf(void* buf, size_t n)` | `void randp_bytes(void* buf, size_t n)` |
| Return a uniform random unsigned integer | `uint32_t arc4random()` | `uint8_t randp_u8()`<br />`uint16_t randp_u16()`<br />`uint32_t randp_u32()`<br />`uint64_t randp_u64()` |
| Return a uniform random unsigned integer less than _upper_bound_ | `uint32_t arc4random_uniform(uint32_t upper_bound)` | `uint32_t randp_lt_u32(uint32_t upper_bound)` |

## Design

The randp structure stores random bytes in a pool that can be retrieved later by the functions listed above.

The `static` `thread_local` randp structure is `mmap`d with flags `MAP_PRIVATE | MAP_ANONYMOUS` and then `madvise`d with `MADV_DONTDUMP` and `MADV_WIPEONFORK`.  Its size is at most one page (4096 B), and it's not allocated until immediately before first use.  See [src/allocate.h](src/allocate.h) for details.

Upon first use, the pseudorandom number generator (PRNG) is initialized/seeded by `getentropy`.  See [src/aes128_prng.h](src/aes128_prng.h) for details.  Then the pool is filled with random bytes generated by the PRNG.

As bytes are retrieved from the pool, they are zeroized.  After a certain number of bytes has been read, the PRNG is reseeded, and the pool is filled again with random bytes.  See [src/randp.c](src/randp.c) for details.

## Benchmark results (2024-08-27)

### System Info

- Linux 6.10.6-arch1-1 x86_64
- 13th Gen Intel(R) Core(TM) i9-13950HX
- ldd (GNU libc) 2.40
- gcc (GCC) 14.2.1 20240805
- librandp.so.4.0

### Fill a buffer with random bytes

| Function | Median time to generate 4 GiB |
|---|---:|
| `randp_bytes`    |  359  ms |
| `getentropy`     | 7569  ms |
| `arc4random_buf` | 7606  ms |

### Get a uniform random `uint32_t`

| Function | Median time per call |
|---|---:|
| `randp_u32`  | 5.54  ns |
| `arc4random` |  167  ns |
| `rdrand32`   |  287  ns |
| `rdseed32`   | 1804  ns |

Note: `rdrand32` and `rdseed32` are wrappers for `_rdrand32_step` and `_rdseed32_step`, respectively.

### Get a uniform random `uint32_t` less than _upper_bound_ = [1 .. 0x100000]

| Function | Median calls per second |
|---|---:|
| `randp_lt_u32`       | 183.058M/s |
| `arc4random_uniform` | 4.38161M/s |

## Dependencies

### To build and use randp

* A processor with [AES instructions](https://en.wikipedia.org/wiki/AES_instruction_set)
* [Linux 4.14](https://kernelnewbies.org/Linux_4.14) or newer
  * [`MADV_WIPEONFORK`](https://man7.org/linux/man-pages/man2/madvise.2.html#:~:text=of%20memory%20pressure.-,MADV_WIPEONFORK) was added in Linux 4.14
* [GCC 14](https://gcc.gnu.org/gcc-14/changes.html) or newer
  * [C23](https://en.cppreference.com/w/c/23) support was added in GCC 14.  randp uses the [`thread_local`](https://en.cppreference.com/w/c/keyword/thread_local) keyword.
* [Glibc 2.25](https://www.phoronix.com/news/glibc-2.25-Released) or newer
  * [`getentropy`](https://man7.org/linux/man-pages/man3/getentropy.3.html) was added in glibc 2.25. [^1] [^2]

[^1]: https://sourceware.org/legacy-ml/libc-alpha/2017-02/msg00079.html

[^2]: https://sourceware.org/bugzilla/show_bug.cgi?id=17252#c7

### To run the benchmarks

* [Google Benchmark](https://github.com/google/benchmark)
* [Glibc 2.36](https://www.phoronix.com/news/GNU-C-Library-Glibc-2.36)
  * [arc4random](https://man7.org/linux/man-pages/man3/arc4random.3.html) functions were added in glibc 2.36, but the interface was <q>added as a basic loop wrapper around `getrandom()`</q>. [^3] [^4]

[^3]: https://lists.gnu.org/archive/html/info-gnu/2022-08/msg00000.html

[^4]: https://lore.kernel.org/all/20220726195822.1223048-1-Jason@zx2c4.com/

### To run the tests

* Glibc 2.36
* RNG_test from [PractRand](https://github.com/planet36/PractRand)
  * This is a _very_ lengthy test, taking about 1 hour for each test run!  To make it quicker (yet less thorough), reduce the values of the `-tf`, `-te`, and `-tlmax` options to `RNG_test`.
* [Valgrind](https://valgrind.org/)
  * [KCachegrind](https://apps.kde.org/kcachegrind/) or QCachegrind to view the output
* rngtest from [rng-tools](https://github.com/nhorman/rng-tools)
* [openssl-rand](https://docs.openssl.org/master/man1/openssl-rand/)

## Tests

randp is fork-safe, just like arc4random.

randp passes PractRand tests through 512 GiB with these exhaustive options: <q>-tf 2</q>, <q>-te 1</q>.  And it scores a similar number of FIPS 140-2 successes and failures as arc4random and openssl-rand.

It has not been tested with [TestU01](https://en.wikipedia.org/wiki/TestU01) and [diehard](https://en.wikipedia.org/wiki/Diehard_tests).

## License

[The Open Software License 3.0](https://opensource.org/license/osl-3-0-php) (OSL-3.0)
